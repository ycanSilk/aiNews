# 数据库迁移指南

## 概述

本文档提供了将现有数据库迁移到新设计的规范化结构的完整指南。

## 新数据库结构

### 1. 分类表 (Categories)
- 多语言名称支持 (zh/en)
- 标准化值字段 (value)
- 显示顺序控制
- 激活状态管理

### 2. 标签表 (Tags) 
- 多语言名称支持 (zh/en)
- 标准化值字段 (value)
- 激活状态管理

### 3. 新闻表 (News)
- 引用分类和标签 (ObjectId引用)
- 热门/推荐标记 (基于浏览量自动设置)
- 多语言内容支持
- 浏览量统计

### 4. 文章表 (Articles)
- 引用分类和标签 (ObjectId引用) 
- 热门/推荐标记 (基于浏览量自动设置)
- 多语言内容支持
- 浏览量统计

## 迁移步骤

### 步骤1: 备份现有数据
```bash
npm run data:backup
```

### 步骤2: 重置数据库（删除所有表并重新创建）
```bash
npm run db:reset
```

### 步骤3: 迁移数据（如果需要从旧结构迁移）
```bash
npm run db:migrate
```

## 脚本说明

### initDatabase.js
主要功能：
- 删除所有现有集合
- 创建新的规范化表结构
- 建立所有索引
- 插入示例分类和标签数据

使用方法：
```bash
npm run db:init
# 或
npm run db:reset
```

### 现有数据迁移
如果需要在保留现有数据的情况下迁移，需要：
1. 导出现有数据
2. 转换数据格式（将字符串分类/标签转换为ObjectId引用）
3. 导入到新结构

## 数据一致性验证

迁移完成后，建议运行验证脚本：
```bash
npm run data:validate
```

## 注意事项

1. **数据丢失警告**: `db:reset` 会删除所有现有数据，请确保已备份
2. **索引创建**: 新结构包含优化索引，提升查询性能
3. **自动热门标记**: 浏览量超过1000会自动标记为热门内容
4. **多语言支持**: 所有内容字段支持中英文版本

## 故障排除

### 常见问题
1. 连接失败：检查MongoDB服务是否运行
2. 权限错误：确保数据库用户有删除集合权限
3. 数据不一致：运行验证脚本检查数据完整性

### 日志查看
所有操作都会在控制台输出详细日志，包括：
- 连接状态
- 集合删除情况  
- 索引创建结果
- 示例数据插入状态

## 支持

如有问题，请检查控制台错误信息或联系开发团队。